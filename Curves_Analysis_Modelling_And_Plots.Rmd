---
title: "Curves Paper Figures and Analysis"
author: "Courtney Goodridge"
date: "11/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages 

```{r}
if(!require(here)) install.packages("here")
library(here)

if(!require(tidyr)) install.packages("tidyr")
library(tidyr)

if(!require(dplyr)) install.packages("dplyr")
library(dplyr)

if(!require(ggplot2)) install.packages("ggplot2")
library(ggplot2)

if(!require(signal)) install.packages("signal")
library(signal)

if(!require(Rmisc)) install.packages("Rmisc")
library(Rmisc)

if(!require(purrr)) install.packages("purrr")
library(purrr)

if(!require(stringr)) install.packages("stringr")
library(stringr)

if(!require(lme4)) install.packages("lme4")
library(lme4)

if(!require(lmerTest)) install.packages("lmerTest")
library(lmerTest)

if(!require(ggsci)) install.packages("ggsci")
library(ggsci)

if(!require(stargazer)) install.packages("stargazer")
library(stargazer)

if(!require(viridis)) install.packages("viridis")
library(viridis)

if(!require(pracma)) install.packages("pracma")
library(pracma)

if(!require(gridExtra)) install.packages("gridExtra")
library(gridExtra)

if(!require(arm)) install.packages("arm")
library(arm)

if(!require(performance)) install.packages("performance")
library(performance)

if(!require(wesanderson)) install.packages("wesanderson")
library(wesanderson)

if(!require(data.table)) install.packages("data.table")
library(data.table)

if(!require(readr)) install.packages("readr")
library(readr)
```

## Load in processed data

```{r}
overall.dat <- read.csv(here::here("Participant_Data/overall_dat.csv"))

onset.timecourse <- read.csv(here::here("Participant_Data/onset_timecourse.csv"))
```

## Removing participants 8 and 10

These participants did not have a valid UK driving license at the time of testing. Removing to avoid confounding effects. 

```{r}
overall.dat <- overall.dat %>%
  dplyr::filter(pNum != 8) %>%
  dplyr::filter(pNum != 10)
```

## Number of trials

percentage of valid trials within each condition. 

```{r}
total.trials <- read.csv(here::here("Participant_Data/total_trials.csv")) %>%
  dplyr::select(total)

too.fast <- overall.dat %>%
  dplyr::filter(rt < .15) %>%
  dplyr::group_by(radius, startingpos) %>%
  dplyr::summarise(too.fast = n()) %>%
  dplyr::ungroup() %>%
  dplyr::select(too.fast)

valid.trials <- overall.dat %>%
  dplyr::filter(rt > .15) %>%
  dplyr::group_by(radius, startingpos) %>%
  dplyr::summarise(valid = n()) %>%
  dplyr::bind_cols(total.trials, too.fast) %>%
  dplyr::group_by(radius, startingpos) %>%
  dplyr::mutate(perc = (valid / total) * 100)  %>%
  dplyr::mutate(total.trials.removed = total - valid)
```

## Theme plot

```{r}
my_cols <- c("#440154FF", "#238A8DFF", "#73D055FF")

theme_plot <- theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15), title = element_text(size = 18), legend.title = element_text(size = 15), legend.text = element_text(size = 15), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## generating midline for manuscript figures

```{r}
RUN radii_midline SCRIPT

# dataframe for all 3 midlines
midline <- dplyr::bind_rows(midline_1000, midline_1500, midline_2000) %>%
  dplyr::rename(radius = radii)
```

## Figure 1: Threshold versus Accumulator. Conceptual differences. 

```{r}
slow.e <- seq(0, 5, 0.1)
fast.e <- seq(0, 10, 0.2)
time <- c(0:50)

dat <- data.frame(time, fast.e, slow.e) %>%
  tidyr::pivot_longer(cols = -time, names_to = "signal_type", values_to = "error")

time.response <- c(18.5, 37, 22, 32)
error.response <- c(3.7, 3.7, 4.4, 3.2)
model <- c("T", "T", "A", "A")

response.dat <- data.frame(time.response, error.response, model)

ggplot() +
  geom_path(dat, mapping = aes(x = time, y = error, col = signal_type)) +
  geom_area(dat %>%
              dplyr::filter(signal_type == "fast.e", error <= 4.4, time <= 22), mapping = aes(x = time, y = error), fill = viridis(2)[1], alpha = 0.5) +
  geom_area(dat %>%
              dplyr::filter(signal_type == "slow.e", error <= 3.2, time <= 32), mapping = aes(x = time, y = error), fill = viridis(2)[2], alpha = 0.5) +
  geom_segment(mapping = aes(x = 22, xend = 22, y = -Inf, yend = 4.4), colour = viridis(2)[1], size = 0.2) +
  geom_segment(mapping = aes(x = 32, xend = 32, y = -Inf, yend = 3.2), colour = viridis(2)[2], size = 0.2) +
  geom_point(response.dat, mapping = aes(x = time.response, y = error.response, shape = model), size = 2, stroke = 1) +
  geom_hline(mapping = aes(yintercept = 3.7), linetype = "dashed") +
  geom_label(aes(x = 0, y = 3.4, label = "Fixed threshold"), fontface = "bold", hjust = 0, vjust = 0.5, colour = "black", fill = "white", label.size = NA, family = "Arial", size = 2.9) +
  scale_shape_manual(name = "Response mode", labels = c("Accumulator", "Threshold"), values = c(3, 5)) +
  scale_colour_manual(name = "Error increase", labels = c("Fast", "Slow"), values = viridis(2)) +
  ylab("Perceived control error E") +
  xlab("Time") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 7)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(0, 39)) +
  theme_plot +
  theme(legend.position = c(0.33, 0.83), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key = element_blank(), legend.key.width = unit(0.5, 'cm'), legend.key.size = unit(0, 'cm'), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_text(size = 12), plot.title = element_text(size = 20, face = "bold"), axis.title.x = element_text(size = 12), axis.ticks.x = element_blank(), axis.text.x = element_blank(), title = element_text(size = 9), legend.title = element_text(size = 11, face = "bold"), legend.text = element_text(size = 11), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.5, "cm"), ends = "last")), axis.line.x = element_line(arrow = grid::arrow(length = unit(0.5, "cm"), ends = "last")))

  ggsave(here::here("Plots/Fig1.tiff"), plot = last_plot(), width = 7, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 2: camera counter rotation in Goodridge et al (2022)

```{r}
trajectory <- read.csv(here::here("Midline_Data/Exp_Design_Data/trajectory.csv"))
experiment_2_coordinates <- read.csv(here::here("Midline_Data/Exp_Design_Data/experiment_2_coordinates.csv"))

no.cam.rotation <- ggplot() +
  geom_path(trajectory %>%
              dplyr::group_by(heading), mapping = aes(x = roadX, y = roadZ, group = .group), linetype = "dashed", col = "black", alpha = 0.5) +
  geom_path(trajectory %>%
              dplyr::group_by(heading) %>%
              dplyr::mutate(roadX = roadX * -1), mapping = aes(x = roadX, y = roadZ, group = .group), linetype = "dashed", col = "black", alpha = 0.5) + 
  geom_point(mapping = aes(x = 0, y = 0), size = 2) +
  geom_curve(aes(x = 0, y = 0, xend = -0.07, yend = 2), colour = "black", size = 0.5, curvature = 0, arrow = arrow(length = unit(0.04, "npc"))) +
  annotate("text", x = -0.12, y = 0, size = 4, label = "T0") +
  geom_point(mapping = aes(x = -0.175, y = 5), size = 2) +
  geom_curve(aes(x = -0.175, y = 5, xend = -0.25, yend = 7), colour = "black", size = 0.5, curvature = 0, arrow = arrow(length = unit(0.04, "npc"))) +
  annotate("text", x = -0.30, y = 5, size = 4, label = "T1") +
  geom_vline(mapping = aes(xintercept = 0), size = 1, alpha = 0.7) +
  ggtitle("A") +
  ylab("z (m)") +
  xlab("x (m)") +
  ylim(0, 20) +
  xlim(-0.7, 0.7) +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 19, face = "bold"), axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.y = element_text(size = 12), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))


cam.rotation <- ggplot() +
  geom_path(trajectory %>%
              dplyr::group_by(heading), mapping = aes(x = roadX, y = roadZ, group = .group), linetype = "dashed", col = "black", alpha = 0.5) +
  geom_path(trajectory %>%
              dplyr::group_by(heading) %>%
              dplyr::mutate(roadX = roadX * -1), mapping = aes(x = roadX, y = roadZ, group = .group), linetype = "dashed", col = "black", alpha = 0.5) + 
  geom_point(mapping = aes(x = 0, y = 0), size = 2) +
  geom_curve(aes(x = 0, y = 0, xend = -0, yend = 2), colour = "black", size = 0.5, curvature = 0, arrow = arrow(length = unit(0.04, "npc"))) +
  annotate("text", x = -0.12, y = 0, size = 4, label = "T0") +
  geom_point(mapping = aes(x = -0.175, y = 5), size = 2) +
  geom_curve(aes(x = -0.175, y = 5, xend = -0.175, yend = 7), colour = "black", size = 0.5, curvature = 0, arrow = arrow(length = unit(0.04, "npc"))) +
  annotate("text", x = -0.30, y = 5, size = 4, label = "T1") +
  geom_vline(mapping = aes(xintercept = 0), size = 1, alpha = 0.7) +
  ggtitle("B") +
  ylab("z (m)") +
  xlab("x (m)") +
  ylim(0, 20) +
  xlim(-0.7, 0.7) +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 19, face = "bold"), axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.y = element_text(size = 12), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))

g <- arrangeGrob(no.cam.rotation, cam.rotation, nrow = 1)
  ggsave(here::here("Plots/Fig2.tiff"), g,  width = 14, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 3: Example of bird's-eye view of experimental setup for current experiment

```{r}
ggplot() +
  geom_path(data = midline %>%
              dplyr::group_by(radius) %>%
              dplyr::filter(x > -.33), mapping = aes(x = x * -1, y = z, group = .group), alpha = .7) +
  geom_vline(mapping = aes(xintercept = 0), linetype = "dashed", size = 1, alpha = 0.5) +
  geom_point(onset.timecourse %>%
               dplyr::group_by(ppid_trialn) %>%
               dplyr::slice(1) %>%
               dplyr::ungroup() %>%
               dplyr::group_by(startingpos) %>%
               dplyr::summarise(x = mean(rotatedX), z = mean(rotatedZ)), mapping = aes(x = x, y = z, fill = as.factor(startingpos)), shape = 21, size = 2) +
  annotate("text", x = 0.37, y = 40, size = 4, label = "2000 m") +
  annotate("text", x = 0.37, y = 32.5, size = 4, label = "1500 m") +
  annotate("text", x = 0.37, y = 26.5, size = 4, label = "1000 m") +
  ylim(0, 40) +
  xlim(0, 0.40) +
  ylab("z (m)") +
  xlab("x (m)") +
  scale_fill_manual(name = " Starting position (m)", values = c("black", "white", "darkgrey"), labels = c("0", "4", "8"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = c(0.60, 0.20), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 19, face = "bold"), axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.y = element_text(size = 12), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))

  ggsave(here::here("Plots/Fig3.tiff"), plot = last_plot(), width = 10, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 4 - experimental condition figures (bird's eye view)

```{r}
ggplot() +
  geom_path(data = midline %>%
              dplyr::group_by(radius) %>%
              dplyr::filter(x > -.3), mapping = aes(x = x * -1, y = z, group = .group), alpha = .7) +
  geom_path(data = midline %>%
              dplyr::group_by(radius) %>%
              dplyr::filter(x < .3), mapping = aes(x = x, y = z, group = .group), alpha = .7) +
  geom_vline(mapping = aes(xintercept = 0), linetype = "dashed", size = 1, alpha = 0.7) +
  geom_point(onset.timecourse %>%
               dplyr::group_by(ppid_trialn) %>%
               dplyr::slice(1) %>%
               dplyr::ungroup() %>%
               dplyr::group_by(startingpos) %>%
               dplyr::summarise(x = mean(rotatedX), z = mean(rotatedZ)), mapping = aes(x = x, y = z, fill = as.factor(startingpos)), shape = 21, size = 2) +
  annotate("text", x = 0.355, y = 38, size = 3, label = "2000 m") +
  annotate("text", x = 0.355, y = 31, size = 3, label = "1500 m") +
  annotate("text", x = 0.355, y = 25, size = 3, label = "1000 m") +
  ylim(0, 40) +
  xlim(-.4, .4) +
  ylab("z (m)") +
  xlab("x (m)") +
  scale_fill_manual(name = " Starting position (m)", values = c("black", "white", "darkgrey"), labels = c("0", "4", "8"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = c(0.21, 0.23), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 19, face = "bold"), axis.title.x = element_text(size = 9), axis.text.x = element_text(size = 9), axis.title.y = element_text(size = 9), axis.text.y = element_text(size = 9), title = element_text(size = 7), legend.title = element_text(size = 8), legend.text = element_text(size = 8))

  ggsave(here::here("Plots/Fig4.tiff"), plot = last_plot(), width = 10, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 4: Reaction time predictions

```{r}
acc.rt <- read.csv(here::here("Prediction_Data/accumulator.steering.preds.radii.RT.csv")) 
thresh.rt <- read.csv(here::here("Prediction_Data/threshold.steering.preds.radii.RT.csv")) 

acc.rt <- acc.rt %>%
  dplyr::rename_all(~c("rt", "startingpos", "radii")) %>%
  dplyr::mutate(model = "accumulator")

thresh.rt <- thresh.rt %>%
  dplyr::rename_all(~c("rt", "startingpos", "radii")) %>%
  dplyr::mutate(model = "threshold")

rt.preds <- dplyr::bind_rows(acc.rt, thresh.rt)

"Accumulator reaction time predictions"
acc.plot.rt <- ggplot(rt.preds %>%
         dplyr::filter(radii == 1000 | radii == 1500 | radii == 2000, model == "accumulator"), mapping = aes(x = radii, y = rt * 1.8, linetype = as.factor(startingpos))) +
  geom_line() +
  facet_wrap(~ model) + 
  scale_y_continuous(breaks = c(0, 1, 2, 3), limits = c(0, 3), labels = scales::number_format(accuracy = 0.1)) +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  xlab("Radius (m)") +
  ylab("Reaction time (s)") +
  ggtitle("A: Accumulator") +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"),  values = c("dotted", "dashed", "solid")) +
  theme_plot +
  theme(legend.position = c(0.55, 0.85), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.4, "cm"), ends = "last")))

"Threshold reaction time predictions"
thresh.plot.rt <- ggplot(rt.preds %>%
         dplyr::filter(radii == 1000 | radii == 1500 | radii == 2000, model == "threshold"), mapping = aes(x = radii, y = rt, linetype = as.factor(startingpos))) +
  geom_line() +
  facet_wrap(~ model) + 
  scale_y_continuous(breaks = c(0, 1, 2, 3), limits = c(0, 3), labels = scales::number_format(accuracy = 0.1)) +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  xlab("Radius (m)") +
  ylab("Reaction time (s)") +
  ggtitle("B: Threshold") +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"),  values = c("dotted", "dashed", "solid")) +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.4, "cm"), ends = "last")))

g <- arrangeGrob(acc.plot.rt, thresh.plot.rt, nrow = 1)
ggsave(here::here("Plots/Fig4.tiff"), g,  width = 10, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 5: Lateral position error predictions and data

```{r}
acc.steering <- read.csv(here::here("Prediction_Data/accumulator.steering.preds.radii.steering.csv")) 
thresh.steering <- read.csv(here::here("Prediction_Data/threshold.steering.preds.radii.steering.csv")) 

acc.steering <- acc.steering %>%
  dplyr::rename_all(~c("steering_rate", "startingpos", "radii")) %>%
  dplyr::mutate(model = "accumulator")

thresh.steering <- thresh.steering %>%
  dplyr::rename_all(~c("steering_rate", "startingpos", "radii")) %>%
  dplyr::mutate(model = "threshold")

steering.preds <- dplyr::bind_rows(acc.steering, thresh.steering)

steering.preds <- steering.preds %>%
  dplyr::filter(radii == 1000 | radii == 1500 | radii == 2000) %>%
  dplyr::mutate(steering_rate = case_when(model == "threshold" & radii == 2000 ~ steering_rate - 0.008,
                                          model == "threshold" & radii == 1500 ~ steering_rate - 0.006,
                                          model == "threshold" & radii == 1000 ~ steering_rate,
                                          model == "accumulator" & radii == 2000 ~ steering_rate,
                                          model == "accumulator" & radii == 1500 ~ steering_rate,
                                          model == "accumulator" & radii == 1000 ~ steering_rate)) %>%
  dplyr::mutate(steering_rate = case_when(model == "threshold" & startingpos == 8 ~ steering_rate + 0.004,
                                          model == "threshold" & startingpos == 4 ~ steering_rate + 0.0037,
                                          model == "threshold" & startingpos == 0 ~ steering_rate + 0.0036,
                                          model == "accumulator" & startingpos == 8 ~ steering_rate,
                                          model == "accumulator" & startingpos == 4 ~ steering_rate,
                                          model == "accumulator" & startingpos == 0 ~ steering_rate))

"Accumulator predictions"
acc.plot.lpe <- ggplot(steering.preds %>%
         dplyr::filter(model == "accumulator"), mapping = aes(x = radii, y = steering_rate, linetype = as.factor(startingpos))) +
  geom_line() +
  facet_wrap(~ model) +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  ylim(0, 0.06) +
  xlab("Radius (m)") +
  ylab("Lateral position error (m)") +
  ggtitle("A: Accumulator") +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"),  values = c("dotted", "dashed", "solid"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = c(.55, .75), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.4, "cm"), ends = "last")))

"Threshold predictions"
thresh.plot.lpe <- ggplot(steering.preds %>%
         dplyr::filter(model == "threshold"), mapping = aes(x = radii, y = steering_rate, linetype = as.factor(startingpos))) +
  geom_line() +
  facet_wrap(~ model) +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  ylim(0, 0.06) +
  xlab("Radius (m)") +
  ylab("Lateral position error (m)") +
  ggtitle("B: Threshold") +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"),  values = c("dotted", "dashed", "solid"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.text.x = element_text(size = 11), axis.title.x = element_text(size = 11), axis.title.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.4, "cm"), ends = "last")))

g <- arrangeGrob(acc.plot.lpe, thresh.plot.lpe, nrow = 1)
ggsave(here::here("Plots/Fig5.tiff"), g,  width = 10, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 6: Steering rate predictions and data

```{r}
acc.steering <- read.csv(here::here("Prediction_Data/accumulator.steering.preds.radii.steering.csv")) 
thresh.steering <- read.csv(here::here("Prediction_Data/threshold.steering.preds.radii.steering.csv")) 

acc.steering <- acc.steering %>%
  dplyr::rename_all(~c("steering_rate", "startingpos", "radii")) %>%
  dplyr::mutate(model = "accumulator") %>%
  dplyr::filter(radii == 1000 | radii == 1500 | radii == 2000) %>%
  dplyr::mutate(steering_rate = steering_rate * 15)

thresh.steering <- thresh.steering %>%
  dplyr::rename_all(~c("steering_rate", "startingpos", "radii")) %>%
  dplyr::mutate(model = "threshold") %>%
    dplyr::filter(radii == 1000 | radii == 1500 | radii == 2000) %>%
      dplyr::mutate(steering_rate = steering_rate * 150) %>%
      dplyr::mutate(steering_rate = case_when(startingpos == 0 ~ 0.270,
                                              startingpos == 4 ~ 0.275,
                                              startingpos == 8 ~ 0.280))

steering.preds.sr <- dplyr::bind_rows(acc.steering, thresh.steering) 

"Accumulator framework predictions plot"
acc.plot.sr <- ggplot(steering.preds.sr %>%
                        dplyr::filter(model == "accumulator"), mapping = aes(x = radii, y = steering_rate, linetype = as.factor(startingpos))) +
  geom_line() +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  ylim(0, 0.7) +
  xlab("Radius (m)") +
  ylab("Steering rate (°/s)") +
  ggtitle("A: Accumulator") +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"),  values = c("dotted", "dashed", "solid"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = c(.55, .85), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.text.x = element_text(size = 11), axis.title.x = element_text(size = 11), axis.title.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.4, "cm"), ends = "last")))

"Threshold framework predictions plot"
thresh.plot.sr <- ggplot(steering.preds.sr %>%
                        dplyr::filter(model == "threshold"), mapping = aes(x = radii, y = steering_rate, linetype = as.factor(startingpos))) +
  geom_line() +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  ylim(0, 0.7) +
  xlab("Radius (m)") +
  ylab("Steering rate (°/s)") +
  ggtitle("B: Threshold") +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"),  values = c("dotted", "dashed", "solid"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_line(arrow = grid::arrow(length = unit(0.4, "cm"), ends = "last")))

g <- arrangeGrob(acc.plot.sr, thresh.plot.sr, nrow = 1)
ggsave(here::here("Plots/Fig6.tiff"), g,  width = 10, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 8: Bird's eye view of experimental conditions

```{r}
ggplot() +
  geom_path(data = midline %>%
              dplyr::group_by(radius) %>%
              dplyr::filter(x > -.3), mapping = aes(x = x * -1, y = z, group = .group), alpha = .7) +
  geom_path(data = midline %>%
              dplyr::group_by(radius) %>%
              dplyr::filter(x < .3), mapping = aes(x = x, y = z, group = .group), alpha = .7) +
  geom_vline(mapping = aes(xintercept = 0), linetype = "dashed", size = 1, alpha = 0.7) +
  geom_point(onset.timecourse %>%
               dplyr::group_by(ppid_trialn) %>%
               dplyr::slice(1) %>%
               dplyr::ungroup() %>%
               dplyr::group_by(startingpos) %>%
               dplyr::summarise(x = mean(rotatedX), z = mean(rotatedZ)), mapping = aes(x = x, y = z, fill = as.factor(startingpos)), shape = 21, size = 2) +
  annotate("text", x = 0.37, y = 38, size = 4, label = "2000 m") +
  annotate("text", x = 0.37, y = 31, size = 4, label = "1500 m") +
  annotate("text", x = 0.37, y = 25, size = 4, label = "1000 m") +
  ylim(0, 40) +
  xlim(-.4, .4) +
  ylab("z (m)") +
  xlab("x (m)") +
  scale_fill_manual(name = " Starting position (m)", values = c("black", "white", "darkgrey"), labels = c("0", "4", "8"), guide = guide_legend(reverse = TRUE)) +
  theme_plot +
  theme(legend.position = c(0.21, 0.20), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 19, face = "bold"), axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.y = element_text(size = 12), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))

ggsave(here::here("Plots/Fig8.tiff"), plot = last_plot(), width = 10, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 9: Average trajectories for each condition

```{r}
my_cols <- c("#440154FF", "#238A8DFF", "#73D055FF")
radii.labs <- c("1000" = "Radius: 1000 m", "1500" = "Radius: 1500 m", "2000" = "Radius: 2000 m")

ggplot() +
  geom_path(data = midline, mapping = aes(x = x * -1, y = z), size = 1) +
  geom_path(data = onset.timecourse %>%
              dplyr::group_by(startingpos, radius, frame) %>%
              dplyr::summarise(x = mean(rotatedX), z = mean(rotatedZ)), mapping = aes(x = x, y = z, linetype = as.factor(startingpos))) +
  geom_point(overall.dat %>%
               dplyr::group_by(startingpos, radius) %>%
               dplyr::summarise(x = mean(rotatedX), z = mean(rotatedZ)), mapping = aes(x = x, y = z, fill = as.factor(startingpos)), shape = 21) +
  scale_fill_manual(name = "Starting position (m)", values = c("black", "white", "darkgrey"), labels = c("0", "4", "8"), guide = FALSE) +
  scale_linetype_manual(name = "Starting position (m)", labels = c("0", "4", "8"), values = c("dotted", "dashed", "solid"), guide = guide_legend(reverse = TRUE)) +
  ylab("z (m)") +
  xlab("x (m)") +
  ylim(0, 20) +
  scale_x_continuous(breaks = c(0, .10, .20), limits = c(-.05, .20), labels = scales::number_format(accuracy = 0.01)) +
  facet_wrap(~ radius, labeller = labeller(radius = radii.labs)) +
  theme_plot +
  theme(legend.position = c(0.25, 0.30), legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 19, face = "bold"), strip.text = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.y = element_text(size = 12), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10)) 

  ggsave(here::here("Plots/Fig9.tiff"), plot = last_plot(), width = 15, height = 10, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 10: reaction time results 

```{r}
"Reaction time data"
errorbar.rt <- summarySE(overall.dat %>%
                           dplyr::mutate(startingpos = as.numeric(startingpos), radius = as.numeric(radius)) %>%
                           dplyr::filter(rt > .15), measurevar = "rt", groupvars = c("radius", "startingpos")) 

data.plot.rt <- ggplot() +
  geom_point(data = errorbar.rt, mapping = aes(x = radius, y = rt)) +
  geom_line(data = errorbar.rt, mapping = aes(x = radius, linetype = as.factor(startingpos), group = as.factor(startingpos), y = rt)) +
  geom_errorbar(data = errorbar.rt, mapping = aes(x = radius, y = rt, ymin = rt - ci, ymax = rt + ci), width = 80) +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  ylim(0.4, 1.1) +
  scale_linetype_manual(name = "Starting position (m)", values = c("dotted", "dashed", "solid")) +
  ggtitle("C: Data") +
  xlab("Radius (m)") +
  ylab("Reaction time (s)") +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), axis.text.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))

g <- arrangeGrob(acc.plot.rt, thresh.plot.rt, data.plot.rt, nrow = 1)
ggsave(here::here("Plots/Fig10.tiff"), g,  width = 15, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 11: lateral position error results

```{r}
"steering bias"
errorbar.sb <- summarySE(overall.dat %>%
                           dplyr::mutate(startingpos = as.numeric(startingpos), radius = as.numeric(radius)) %>%
                           dplyr::filter(rt > .15), measurevar = "steeringbias", groupvars = c("radius", "startingpos")) 

data.plot.sb <- ggplot() +
  geom_point(data = errorbar.sb, mapping = aes(x = radius, y = steeringbias)) +
  geom_line(data = errorbar.sb, mapping = aes(x = radius, linetype = as.factor(startingpos), group = as.factor(startingpos), y = steeringbias)) +
  geom_errorbar(data = errorbar.sb, mapping = aes(x = radius, y = steeringbias, ymin = steeringbias - ci, ymax = steeringbias + ci), width = 80) +
  scale_x_continuous(breaks = c(1000, 1500, 2000), limits = c(900, 2100)) +
  ylim(0, 0.08) +
  scale_linetype_manual(name = "Starting position (m)", values = c("dotted", "dashed", "solid")) +
  ggtitle("C: Data") +
  xlab("Radius (m)") +
  ylab("Lateral position error (m)") +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), axis.text.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))

g <- arrangeGrob(acc.plot.lpe, thresh.plot.lpe, data.plot.sb, nrow = 1)
ggsave(here::here("Plots/Fig11.tiff"), g,  width = 15, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```

## Figure 12: steering rate

```{r}
"steering rate"
errorbar.sr <- summarySE(overall.dat %>%
                           dplyr::mutate(startingpos = as.numeric(startingpos), radius = as.numeric(radius)) %>%
                           dplyr::filter(rt > .15), measurevar = "peak.sr", groupvars = c("radius", "startingpos")) 

data.plot.sr <- ggplot() +
  geom_point(data = errorbar.sr, mapping = aes(x = radius, y = peak.sr)) +
  geom_line(data = errorbar.sr, mapping = aes(x = radius, linetype = as.factor(startingpos), group = as.factor(startingpos), y = peak.sr)) +
  geom_errorbar(data = errorbar.sr, mapping = aes(x = radius, y = peak.sr, ymin = peak.sr - ci, ymax = peak.sr + ci), width = 80) +
  scale_x_continuous(name = "Radius (m)", breaks = c(1000, 1500, 2000)) +
  ylim(0, .70) +
  scale_linetype_manual(name = "Starting position (m)", values = c("dotted", "dashed", "solid")) +
  ggtitle("C: Data") +
  ylab("Steering rate (°/s)") +
  theme_plot +
  theme(legend.position = "none", legend.key.height = unit(0, 'cm'), legend.key.width = unit(0.5, 'cm'), legend.key = element_blank(), strip.text.x = element_blank(), panel.spacing = unit(2, "lines"), legend.spacing.y = unit(0.1, "cm"), legend.margin = margin(0.05,0.05,0,0, unit = "cm"), legend.key.size = unit(0, 'cm'), plot.title = element_text(size = 12, face = "bold"), axis.title.x = element_text(size = 11), axis.text.x = element_text(size = 11), axis.title.y = element_text(size = 11), axis.text.y = element_text(size = 11), title = element_text(size = 7), legend.title = element_text(size = 10), legend.text = element_text(size = 10))

g <- arrangeGrob(acc.plot.sr, thresh.plot.sr, data.plot.sr, nrow = 1)
ggsave(here::here("Plots/Fig12.tiff"), g,  width = 15, height = 7, units = 'cm', dpi = 600, type = 'cairo')
```


## Modelling for reaction time - Table 1

```{r}
## Distributional shape for rts across conditions
ggplot(overall.dat %>%
         dplyr::filter(rt > .15), mapping = aes(x = rt, col = as.factor(radius))) +
  geom_density() +
  facet_wrap(~ startingpos)
  

# Fitting models with Gaussian, Inverse Gaussian, and Gamma distributions.
gaus.rt <- lmerTest::lmer(rt ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum),
                                   data = overall.dat %>%
                                     dplyr::filter(rt > .15), 
                                   REML = FALSE)

gamma.rt <- glmer(rt ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum),
                           nAGQ = 0,
                           family = Gamma(link = "identity"),
                           data = overall.dat %>%
                             dplyr::filter(rt > .15))

invgaus.rt <- glmer(rt ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum),
                              nAGQ = 0,
                              family = inverse.gaussian(link = "identity"), 
                              data = overall.dat %>%
                          dplyr::filter(rt > .15))

## comparing AICs - inverse gaussian model produces most parsimonious fit
AIC(gaus.rt, gamma.rt, invgaus.rt)

## testing for singular random effects - random correlations make up a lot of parameters and are close to 1 - remove those first (Singmann et al, 2019)

isSingular(invgaus.rt)
VarCorr(invgaus.rt)

## removing singular correlations rat
invgaus.rt.no.correlation <- glmer(rt ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled || pNum),
                                   nAGQ = 0,
                                   family = inverse.gaussian(link = "identity"),
                                   data = overall.dat %>%
                                     dplyr::filter(rt > .15))

## removing correlation produces non-singular model
isSingular(invgaus.rt.no.correlation)

## summarizing final model
summary(invgaus.rt.no.correlation)

# now to put the model into a table
stargazer(invgaus.rt.no.correlation, type = "text", 
          order = c("Constant"),
          coef = list(round(fixef(invgaus.rt.no.correlation), 4)),
          se = list(round(se.fixef(invgaus.rt.no.correlation), 4)),
          single.row = T,
          omit.table.layout = "s",
          add.lines = list(c("Participants", as.numeric(sapply(ranef(invgaus.rt.no.correlation),nrow)[1])),
                           c("Observations", nobs(invgaus.rt.no.correlation))),
          dep.var.labels = "Reaction time",
          model.names = FALSE,
          title = "Fixed effects",
          out = here::here("Plots/rt.table1.html")
          )
```

## Modelling lateral position errors - Table 2

```{r}
## Distributional shape for steering bias across conditions
ggplot(overall.dat %>%
         dplyr::filter(rt > .15), mapping = aes(x = steeringbias, col = as.factor(radius))) +
  geom_density() +
  facet_wrap(~ startingpos)
  
## fitting full models
gaus.sb <- lmerTest::lmer(steeringbias ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum),
                          REML = FALSE,
                          data = overall.dat %>%
                            dplyr::filter(rt > .15))

gamma.sb <- glmer(steeringbias ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum),
                           nAGQ = 0,
                           family = Gamma(link = "identity"),
                           data = overall.dat %>%
                             dplyr::filter(rt > .15))

invgaus.sb <- glmer(steeringbias ~ radius_scaled * startingpos_scaled +(radius_scaled * startingpos_scaled | pNum), 
                        nAGQ = 0,
                        family = inverse.gaussian(link = "identity"),
                        data = overall.dat %>%
                          dplyr::filter(rt > .15))

## assessing AICs
AIC(gaus.sb, gamma.sb, invgaus.sb)

## is the model singular - interaction random effect has very low variance
isSingular(gamma.sb)
VarCorr(gamma.sb)

## comparing full model to reduced model - model significantly better with random interaction included
gamma.sb.no.correlation <- glmer(steeringbias ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled || pNum),
                                     nAGQ = 0,
                                     family = Gamma(link = "identity"),
                                     data = overall.dat %>%
                                       dplyr::filter(rt > .15))

isSingular(gamma.sb.no.correlation)

## summarising model
summary(gamma.sb.no.correlation)

## saving table
stargazer(gamma.sb.no.correlation, type = "text", 
          order = c("Constant"),
          coef = list(round(fixef(gamma.sb.no.correlation), 4)),
          se = list(round(se.fixef(gamma.sb.no.correlation), 4)),
          single.row = T,
          omit.table.layout = "s",
          add.lines = list(c("Participants", as.numeric(sapply(ranef(gamma.sb.no.correlation),nrow)[1])),
                           c("Observations", nobs(gamma.sb.no.correlation))),
          dep.var.labels = "Lateral position error",
          model.names = FALSE,
          title = "Fixed effects",
          out = here::here("Plots/sb.table1.html")
)
```

## Modelling steering rate - Table 3

```{r}
## Distributional shape for steering bias across conditions
ggplot(overall.dat %>%
         dplyr::filter(rt > .15), mapping = aes(x = peak.sr, col = as.factor(radius))) +
  geom_density() +
  facet_wrap(~ startingpos)

## fitting full models
gaus.sr <- lmerTest::lmer(peak.sr ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum),
                                        REML = FALSE,
                                        data = overall.dat %>%
                                          dplyr::filter(rt > .15))

gamma.sr <- glmer(peak.sr ~ radius_scaled * startingpos_scaled  + (radius_scaled * startingpos_scaled | pNum), 
                           nAGQ = 0,
                           family = Gamma(link = "identity"), 
                           data = overall.dat %>%
                             dplyr::filter(rt > .15))

invgaus.sr <- glmer(peak.sr ~ radius_scaled * startingpos_scaled + (radius_scaled * startingpos_scaled | pNum), 
                             nAGQ = 0,
                             family = inverse.gaussian(link = "identity"),
                             data = overall.dat %>%
                               dplyr::filter(rt > .15))


## computing AICs
AIC(gaus.sr, gamma.sr, invgaus.sr)

## is the model singular
isSingular(gamma.sr)
VarCorr(gamma.sr)

## removing singular correlations from random effects
gamma.sr.no.correlation <- glmer(peak.sr ~ radius_scaled * startingpos_scaled  + (radius_scaled * startingpos_scaled || pNum), 
                           nAGQ = 0,
                           family = Gamma(link = "identity"), 
                           data = overall.dat %>%
                             dplyr::filter(rt > .15))

isSingular(gamma.sr.no.correlation)

## summarising model
summary(gamma.sr.no.correlation)

## saving out table for steering rate metric
stargazer(gamma.sr.no.correlation, type = "text", 
          order = c("Constant"),
          coef = list(round(fixef(gamma.sr.no.correlation), 4)),
          se = list(round(se.fixef(gamma.sr.no.correlation), 4)),
          single.row = T,
          omit.table.layout = "s",
          add.lines = list(c("Participants", as.numeric(sapply(ranef(gamma.sr.no.correlation),nrow)[1])),
                           c("Observations", nobs(gamma.sr.no.correlation))),
          dep.var.labels = "Steering rate",
          model.names = FALSE,
          title = "Fixed effects",
          out = here::here("Plots/sr.table1.html") 
          )
```